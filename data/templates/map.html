{% extends "base.html" %}

{% load humanize %}
{% load profiletags %}

{% block title %}Mapping Crimes Against Humanity: Enforced Disappearances &amp; Extrajudicial Executions in Punjab, India{% endblock %}

{% block head %}

  <meta name="description" content="A portrait of widespread &amp; systematic enforced disappearances &amp; extrajudicial executions, based on data collected through primary source interviews." />

  <meta itemprop="name" content="Mapping Crimes Against Humanity: Enforced Disappearances &amp; Extrajudicial Executions in Punjab, India" />
  <meta itemprop="description" content="A portrait of widespread &amp; systematic enforced disappearances &amp; extrajudicial executions, based on data collected through primary source interviews." />
  <meta itemprop="image" content="https://data.ensaaf.org/static/images/social-share.jpg" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@ensaaf" />
  <meta name="twitter:title" content="Mapping Crimes Against Humanity: Enforced Disappearances &amp; Extrajudicial Executions in Punjab, India" />
  <meta name="twitter:description" content="A portrait of widespread &amp; systematic enforced disappearances &amp; extrajudicial executions, based on data collected through primary source interviews." />
  <meta name="twitter:creator" content="@ensaaf" />
  <meta name="twitter:image" content="https://data.ensaaf.org/static/images/social-share.jpg" />

  <meta property="og:title" content="Mapping Crimes Against Humanity: Enforced Disappearances &amp; Extrajudicial Executions in Punjab, India" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://data.ensaaf.org" />
  <meta property="og:image" content="https://data.ensaaf.org/static/images/social-share.jpg" />
  <meta property="og:description" content="A portrait of widespread &amp; systematic enforced disappearances &amp; extrajudicial executions, based on data collected through primary source interviews." />
  <meta property="og:site_name" content="Mapping Crimes Against Humanity: Enforced Disappearances &amp; Extrajudicial Executions in Punjab, India" />

  <link rel="stylesheet" href="/static/css/leaflet.css" />
  <link rel="stylesheet" href="/static/css/font-awesome.min.css"/>
  <script type="text/javascript" src="/static/js/leaflet.js"></script>
  <script type="text/javascript" src="/static/js/leaflet.zoomhome.min.js"></script>

  <style>
    #mapid {
      height:600px;
      width:100%;
      background-color: #000;
    }
    .leaflet-interactive { cursor: default; }
    .leaflet-popup-content-wrapper { border-radius: 2px; }
    .leaflet-control-attribution { display: none; }  

    .leaflet-control-zoomhome a {
        font: bold 18px "Lucida Console",Monaco,monospace;
    }
    a.leaflet-control-zoomhome-in,
    a.leaflet-control-zoomhome-out {
      font-size: 1.5em;
      line-height: 26px;
    }
  </style>
  <script type="text/javascript" src="/static/js/d3.v4.min.js"></script>
  <script type="text/javascript" src="/static/js/lodash.min.js"></script>
{% endblock %}


{% block content %}

<div class="row">
    <div class="col-12">
      <h2 style="margin-bottom:0;">Mapping Crimes Against Humanity</h2>
      <h4 style="margin-top:0;">Enforced Disappearances &amp; Extrajudicial Executions in Punjab, India</h4>
    </div>
</div>



<form method="get" id="form">


<div class="row" id="clear-filters"{%if selected %} style="display:block;"{%endif%}>
  <div class="col-12">
      <p class="float-right"><a href="#" onclick="clearFilters();return false;">Clear filters</a></p>
  </div>
</div>

<div class="row">

    <div class="form-group filter{% if selected_age %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="age" name="age" onchange="updateMapData()">
        <option value="">Age</option>
        <option{% if selected_age == '0-17' %} selected=selected{% endif %}>0-17</option>
        <option{% if selected_age == '18-33' %} selected=selected{% endif %}>18-33</option>
        <option{% if selected_age == '34-49' %} selected=selected{% endif %}>34-49</option>
        <option{% if selected_age == '50-64' %} selected=selected{% endif %}>50-64</option>
        <option{% if selected_age == '65+' %} selected=selected{% endif %}>65+</option>
      </select>
    </div>


    <div class="form-group filter{% if selected_caste %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="caste" name="caste" onchange="updateMapData()">
        <option value="">Caste</option>
        <option{% if selected_caste == 'Chamar' %} selected=selected{% endif %}>Chamar</option>
        <option{% if selected_caste == 'Dalit/SC/BC' %} selected=selected{% endif %}>Dalit/SC/BC</option>
        <option{% if selected_caste == 'Jat' %} selected=selected{% endif %}>Jat</option>
        <option{% if selected_caste == 'Khatri' %} selected=selected{% endif %}>Khatri</option>
        <option{% if selected_caste == 'Mazbi' %} selected=selected{% endif %}>Mazbi</option>
        <option{% if selected_caste == 'Naee' %} selected=selected{% endif %}>Naee</option>
        <option{% if selected_caste == 'Ramgarhia' %} selected=selected{% endif %}>Ramgarhia</option>
        <option{% if selected_caste == 'Other' %} selected=selected{% endif %}>Other</option>
      </select>
    </div>
        
    <div class="form-group filter{% if selected_classification %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="classification" name="classification" onchange="updateMapData()">
        <option value="">Classification</option>
        <option {% if selected_classification == 'Enforced Disappearance' %} selected=selected{% endif %} value="Enforced Disappearance">Enforced Disappearance</option>
        <option {% if selected_classification == 'Extrajudicial Execution' %} selected=selected{% endif %} value="Extrajudicial Execution">Extrajudicial Execution</option>
      </select>
    </div>
    
    <div class="form-group filter{% if selected_gender %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="gender" name="gender" onchange="updateMapData()">
        <option value="">Gender</option>
        <option {% if selected_gender == 'Female' %} selected=selected{% endif %} value="Female">Female</option>
        <option {% if selected_gender == 'Male' %} selected=selected{% endif %} value="Male">Male</option>
      </select>
    </div>

    <div class="form-group filter{% if selected_combatant %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="combatant" name="combatant" onchange="updateMapData()">
        <option value="">Combatant Status</option>
        <option {% if selected_combatant == 'Combatant' %} selected=selected{% endif %} value="Combatant">Combatant</option>
        <option {% if selected_combatant == 'Non-Combatant' %} selected=selected{% endif %} value="Non-Combatant">Non-Combatant</option>
        <option {% if selected_combatant == 'Unknown' %} selected=selected{% endif %} value="Unknown">Unknown</option>
      </select>
    </div>

    <div class="form-group filter{% if selected_religion %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="religion" name="religion" onchange="updateMapData()">
        <option value="">Religion</option>
        <option{% if selected_religion == 'Christian' %} selected=selected{% endif %}>Christian</option>
        <option{% if selected_religion == 'Hindu' %} selected=selected{% endif %}>Hindu</option>
        <option{% if selected_religion == 'Muslim' %} selected=selected{% endif %}>Muslim</option>
        <option{% if selected_religion == 'Sikh' %} selected=selected{% endif %}>Sikh</option>
        <option{% if selected_religion == 'No religion' %} selected=selected{% endif %}>No religion</option>
        <option{% if selected_religion == 'Other' %} selected=selected{% endif %}>Other</option>
      </select>
    </div>

    <div class="form-group filter{% if selected_district %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="district" name="district" onchange="updateMapData()">
        <option value="">District</option>
        {% for o in districts %}
        <option value="{{o.district_id}}" {% if selected_district|add:"0" == o.district_id %} selected=selected{% endif %}>{{o.district}}</option>
        {% for t in o.subdistricts %}
        <option value="{{t.tehsil_id}}" {% if selected_district|add:"0" == t.tehsil_id %} selected=selected{% endif %}>&nbsp;&nbsp;- {{t.tehsil}}</option>
        {% endfor %}
        {% endfor %}
      </select>
    </div>

    <div class="form-group filter{% if selected_urban_rural %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="urban_rural" name="urban_rural" onchange="updateMapData()">
        <option value="">Urban / Rural</option>
        <option {% if selected_urban_rural == 'Urban' %} selected=selected{% endif %} value="Urban">Urban</option>
        <option {% if selected_urban_rural == 'Rural' %} selected=selected{% endif %} value="Rural">Rural</option>
      </select>
    </div>

    <div class="form-group filter{% if selected_year %} selected{% endif %} col-6 col-md-3 col-lg-2">
      <select class="form-control" id="year" name="year" onchange="updateMapData()">
        <option value="">Year</option>
        {% for o in years %}
        <option{% if selected_year|add:"0" == o %} selected=selected{% endif %}>{{o}}</option>
        {% endfor %}
      </select>
    </div>

</div>
    
</form>


</div><!-- end container -->



<div id="map-over">
  <div class="container">
    <h4>At least <span id="count">{{all|length|intcomma}}</span> Enforced Disappearance<span class="count-plural">s</span>/Extrajudicial Execution<span class="count-plural">s</span></h4>
  </div><!-- end container -->
</div>
<div id="mapid">
</div>
<div id="year_buttons"></div>

<div id="timeline"></div>
  
<div class="container">

  <div class="row">
    <div class="col-12">
      <p>The Crimes Against Humanity Data Project is a portrait of widespread and systematic enforced disappearances and extrajudicial executions, based on data collected through primary source interviews. Ensaaf created this site to build informed consensus on the nature of the crimes perpetrated by India’s security forces in Punjab. <a href="/about/">Read more about our goals »</a></p>
    </div>
  </div>



<script type="text/javascript">


// make year buttons
for (i = 1984; i<=2000; i++) {
  $('#year_buttons').append('<button type="button" class="btn btn-dark">'+i+'</button>');
}
$('#year_buttons button').on('click', function(e) {
  console.log(e);
  $("#year").val(e.target.innerText);
  updateMapData();
});



function numberWithCommas(x) {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}



var timeCapsule = [{% for o in all %}{"v":{"vid":"{{o.village_id|default:"0"}}","t":{{o.timeline|date:"U"|default:"0"}}}}{% if forloop.last %}{%else%},{% endif %}{% endfor %}];

for (var i=0;i<timeCapsule.length;i++) {
    if ( timeCapsule[i]['v']['vid'] ) {
      timeCapsule[i]['date'] = timeCapsule[i]['v']['t'];
      var d = new Date(0);
      timeCapsule[i]['date'] = d.setUTCSeconds( timeCapsule[i]['date'] );
    }
}  

var start = d3.min(d3.entries(timeCapsule), function(d) { return d.value.date; });
var end = d3.max(d3.entries(timeCapsule), function(d) { return d.value.date; });

var villages = {};
var villageCentroids = [];
var markers = {};




function clearFilters() {
  $("#form option[selected]").removeAttr("selected");    
  $("#form .filter").removeClass('selected');
  $("#form .filter select").val($("#form option:first").val());
  updateMapData();
  mymap.setView([31.0157601,75.45], 8);
}


function updateMapData() {

  var hasFilters = 0;
  
  $('.filter select').each(function(i, obj) {
    $o = $(obj);
    if ($o.val() !== '') {
      $o.parent().addClass('selected'); 
      hasFilters = 1;
    } else {
      $o.parent().removeClass('selected');
    }
  });

  if (hasFilters) {
    $('#clear-filters').fadeIn(); 
  } else {
    $('#clear-filters').hide(); 
  }

  var params = $('#form').serialize();

  $.getJSON("/map_ajax/?" + params, function(json) {
      timeCapsule = [];
      timeCapsule = json.timeline;

      $("#count").html( numberWithCommas(timeCapsule.length) );
      if (timeCapsule.length == 1) {
        $(".count-plural").html("");
      } else {     
        $(".count-plural").html("s");
      }
      
      for (var i=0;i<timeCapsule.length;i++) {
          if ( timeCapsule[i]['v']['t']  < 1514764800 ) {
            timeCapsule[i]['date'] = timeCapsule[i]['v']['t'];
            var d = new Date(0);
            timeCapsule[i]['date'] = d.setUTCSeconds( timeCapsule[i]['date'] );
          }
      } 
     
      history.pushState(params,'Mapping Crimes Against Humanity in Punjab, India: Enforced Disappearances and Extrajudicial Executions', "/?" + params);

      makeVillageNames(start, end);
  })
  .fail(function(error) {
    console.log("error");
    console.log(error);
  })

}





// init

var previousDistrict = '';


// load basemap

var options = { minZoom: 4, maxZoom: 12, zoomControl: false };

var mymap = L.map('mapid', options).setView([31.0157601,75.45], 8);

L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png', {
	subdomains: 'abcd',
  attribution: '',
}).addTo(mymap);

var zoomHome = L.Control.zoomHome({ zoomHomeIcon: 'refresh' });
zoomHome.addTo(mymap);
mymap.scrollWheelZoom.disable();
 


// load punjab provinces

var punjabStyle = { "color": "#999", "weight": 1, "opacity": 0.65, "fillOpacity": 0 };
var punjab = new L.geoJson();
punjab.addTo(mymap);
$.ajax({
  dataType: "json",
  url: "/static/js/punjab.geojson",
  success: function(data) {
      $(data.features).each(function(key, data) {
          punjab.addData(data);
      });
      punjab.setStyle(punjabStyle);
      punjab.bringToBack()
  }
});



// load India country borders

var indiaStyle = { "color": "#fff", "weight": 1, "opacity": 0.65, "fillOpacity": 0 };
var india = new L.geoJson();
india.addTo(mymap);
$.ajax({
  dataType: "json",
  url: "/static/js/india.geojson",
  success: function(data) {
      $(data.features).each(function(key, data) {
          india.addData(data);
      });
      india.setStyle(indiaStyle);
      india.bringToBack()
  }
});



// load disputed borders

var disputedStyle = { "color": "#666", "weight": 1, "opacity": 0.65, "fillOpacity": 0, "dashArray": "2 2" };
var disputed = new L.geoJson();
disputed.addTo(mymap);
$.ajax({
  dataType: "json",
  url: "/static/js/disputed.geojson",
  success: function(data) {
      $(data.features).each(function(key, data) {
          disputed.addData(data);
      });
      disputed.setStyle(disputedStyle);
      disputed.bringToBack()
  }
});



// load village centroids

$.getJSON("/static/js/village_loc.json", function(json) {
    villageCentroids = json
    makeTimeline();
});




function makeVillageNames(start, end) {

    villages = {};

    // update size per village
    for (var i=0;i<timeCapsule.length;i++) {
        if ((end >= timeCapsule[i]['date']) && (timeCapsule[i]['date'] >= start) && ( timeCapsule[i]['v']['vid'] ))  {
          var id = timeCapsule[i]['v']['vid'];
          villages[id] = (villages[id] || 0) + 1;
        }
    }
    
    updateMap(start, end);
}



var area = d3.scalePow().exponent(0.5).domain([0, 100]).range([1, 15]);



function updateMap(start, end) {

    // make map
    var points = [];
    var keys = Object.keys(villages);
    for (var i in keys) {
      var thisVillage = _.find(villageCentroids, function(o) {
        return o.CODE.endsWith(keys[i]);        
      });
      if (keys[i] && thisVillage) {
        points.push({'id':keys[i],'coord':thisVillage.coord,'subdist':thisVillage.SUBDIST,'dist':thisVillage.DIST,'size':villages[keys[i]],'name':thisVillage.NAME});
      }
    }



    // test Object.keys(markers).length to see less than total? see if need to recreate map or just update


    if (Object.keys(markers).length > 0) {

        var params = $('#form').serialize();
        var markers_array = [];

        // update markers
        _.forEach(markers, function(value, key) {
          if ( d = _.find(points, { 'id': key }) ) {
              markers[key].setStyle({fillOpacity: .5});
              markers[key].setRadius(area(d.size));

              var tultipText = '<div class="name">' + d.name + '</div><div class="position">' + d.size + ' Victim';
                if (d.size > 1) { tultipText += 's'; }
                tultipText += '</div>';

              markers[key].bindPopup(tultipText);
              markers_array.push( markers[key] );
          } else {
            markers[key].setStyle({fillOpacity: 0});            
            markers[key].unbindPopup();
          }
        });

        if ( $( "#district" ).val() !== '' ) {
          // zoom to district
          var group = new L.featureGroup(markers_array);
          var bounds = group.getBounds();
          var buffer = {
            "lat": (bounds._northEast.lat - bounds._southWest.lat) * .15,
            "lng": (bounds._northEast.lng - bounds._southWest.lng) * .15
            };
          bounds._northEast.lat = bounds._northEast.lat + buffer.lat;
          bounds._northEast.lng = bounds._northEast.lng + buffer.lng;
          bounds._southWest.lat = bounds._southWest.lat - buffer.lat;
          bounds._southWest.lng = bounds._southWest.lng - buffer.lng;
          mymap.flyToBounds(bounds);
          previousDistrict = $( "#district" ).val();
        } else if (previousDistrict) {
          // reset map zoom
          mymap.setView([31.0157601,75.45], 8);            
        }
    
    } else {
        
        // create map
        _.forEach(points, function(d) {

          if (d.id !== '0') {
            var customCircleMarker = L.CircleMarker.extend({
               options: { 
                  url: '/village/' + d.id,
               }
            });
            markers[String(d.id)] = new customCircleMarker([d.coord[1] + .015,d.coord[0] - .025], {
                stroke: false,
                fillColor: '#fc0',
                fillOpacity: 0.5,
                url: '/village/' + d.id,
            }).addTo(mymap);

            var tultipText = '<div class="name">' + d.name + ', ';
              if (d.subdist !== d.dist) { tultipText += d.subdist + ', '; }
              tultipText += d.dist + '</div><div class="position">' + d.size + ' Victim';
              if (d.size > 1) { tultipText += 's'; }
              tultipText += '</div>';

            var url = '/village/' + d.id;

            markers[String(d.id)].bindPopup(tultipText);
            markers[String(d.id)].on('mouseover', function (e) { this.openPopup(); });
            markers[String(d.id)].on('mouseout', function (e) { this.closePopup(); });
            markers[String(d.id)].on('click', function (e) {
              var params = $('#form').serialize();
              document.location.href = this.options.url + '/?' + params;
            });
          }
          
        }); // end for points

    } // end if markers

}





function makeTimeline() {
    
  var start = d3.min(d3.entries(timeCapsule), function(d) { return d.value.date; });
  var end = d3.max(d3.entries(timeCapsule), function(d) { return d.value.date; });

  // Some victims have t=0. will have to account for this when we put the brushable timline back in
  if ( $( "#year" ).val() == '' ) {  start = new Date(0); }

  var xScale = d3.scaleTime().domain([start, end]).rangeRound([0, 100]);

  var brush = d3.brushX().on("brush end", brushed);

  var svg = d3.select("#timeline").append("svg");

  function brushed() {
    var s = xScale.range();
    makeVillageNames( xScale.invert(s[0]), xScale.invert(s[1]) );
  }

  svg.append("g")
      .attr("class", "brush")
      .call(brush)
      .call(brush.move, xScale.range());

} // end makeTimeline



</script>

{% endblock %}